@using FPLSP_Tutorial.WASM.Data.DataTransferObjects.Major;
@using FPLSP_Tutorial.WASM.Data.DataTransferObjects.Post.Request;
@using FPLSP_Tutorial.WASM.Data.DataTransferObjects.Tag;
@inject IDialogService DialogService

@inject IMajorRepository _repoMajor
@inject ITagRepository _repoTag

<style>
    :root {
        --mud-zindex-popover: 2001
    }

    .mud-input-control {
        margin-top: 0px;
    }
</style>

<MudOverlay Visible="@Visible" LightBackground="true" ZIndex="1300">
    <MudPaper Class="px-5 pt-2 pb-1" Style="width: 40vw">
        @if (_isLoadingAll)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Info"></MudProgressLinear>
        }
        else
        {
            <div>
                <MudText Typo="Typo.h6" Style="font-weight: 500">Thông tin bài viết</MudText>
            </div>
            <div class="row">
                <div class="col">
                    <MudText Typo="Typo.caption">Tiêu đề</MudText>
                    <MudTextField Variant="Variant.Outlined" @bind-Value="@_bindTitle"></MudTextField>
                </div>

            </div>
            <div class="row">
                <AuthorizeView Roles="ADMIN">
                    <div class="col">
                        <MudText Typo="Typo.caption">Loại hình bài viết</MudText>
                        <MudSelect Variant="Variant.Outlined" Value="@_selectedPostType" ValueChanged="@((bool val) => OnSelectPostType(val))" AnchorOrigin="Origin.BottomCenter" Disabled="@_disablePostType">
                            <MudSelectItem Value="true">Hệ thống</MudSelectItem>
                            <MudSelectItem Value="false">Chuyên ngành</MudSelectItem>
                        </MudSelect>
                    </div>
                </AuthorizeView>

                @if (!_selectedPostType)
                {
                    <div class="col">
                        <MudText Typo="Typo.caption">Chuyên ngành</MudText>
                        <MudSelect Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Value="@_selectedMajorId" ValueChanged="@((Guid val) => OnSelectMajor(val))">
                            @foreach (var i in _listMajor.OrderByDescending(c => c.ListTag.Count()))
                            {
                                <MudSelectItem Value="@i.Id" Disabled="@(i.ListTag.Count == 0)">@i.Name (@i.ListTag.Count())</MudSelectItem>
                            }
                        </MudSelect>
                    </div>
                }
            </div>
            <div class="row">
                <div class="col">
                    <MudText Typo="Typo.caption">Nhãn</MudText>
                    <div style="border: 1px solid lightgrey; border-radius: 8px">
                        <div class="d-flex align-center" style="min-height: 48px;">
                            @foreach (var i in ListTagSelected)
                            {
                                <MudChip Variant="Variant.Outlined" Size="Size.Small" @onmouseover="@(() => TagOnMouseOver(i.Id))" @onmouseleave="@(() => _hovingTagId = null)" Icon="@(_hovingTagId == i.Id ? Icons.Material.Filled.Delete : null)" OnClick="@(() => TagOnClickRemove(i.Id))">@i.Name</MudChip>
                            }
                            <MudIcon Icon="@Icons.Material.Filled.AddCircle" @onclick="@(async () => await OnClickTagAdd())" Class="@(ListTagSelected.Count() == 0 ? "ms-3" : "")"></MudIcon>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end my-2">
                <MudButton OnClick="@(async () => { Visible = false; await OnClose.InvokeAsync(); })">Hủy</MudButton>
                <MudButton OnClick="@(async () => await OnClickSave())">Lưu</MudButton>
            </div>
        }
    </MudPaper>
</MudOverlay>

@code {
    private bool _isLoadingAll = false;

    [Parameter]
    public Guid UserId { get; set; }

    [Parameter]
    public PostCreateRequest PostCreateRequest { get; set; } = new();

    [Parameter]
    public bool Visible { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public List<TagDTO> ListTagSelected { get; set; } = new();

    [Parameter]
    public EventCallback<List<TagDTO>> BindListTagSelected { get; set; }

    private string _bindTitle = "";

    private bool _selectedPostType = false;
    private bool _disablePostType = true;
    private Guid _selectedMajorId = Guid.Empty;

    private Guid? _hovingTagId = null;
    private List<TagDTO> _listTagForSelect = new();
    private List<TagDTO> _listTagSystem = new();

    private List<MajorDTO> _listMajor = new();



    protected override async Task OnInitializedAsync()
    {
        _isLoadingAll = true;
        await LoadData().ContinueWith((re) =>
        {
            _isLoadingAll = false;
        });
    }

    private async Task LoadData()
    {
        _listTagSystem = await _repoTag.GetListAsync(new()
        {
            IgnoreMajorId= true
        });
        _listMajor = await _repoMajor.GetListAsync(new()
            {
                UserId = UserId,
            });
        if (_listMajor.Count() > 0)
        {
            _disablePostType = false;
            _selectedMajorId = _listMajor.First().Id;
        }
        SetTagDisplay();
    }

    private void OnSelectPostType(bool val)
    {
        _selectedPostType = val;
        SetTagDisplay();
    }

    private void OnSelectMajor(Guid val)
    {
        _selectedMajorId = val;
        SetTagDisplay();
    }

    private void SetTagDisplay()
    {
        ListTagSelected = new();
        if(_selectedPostType)
        {
            _listTagForSelect = _listTagSystem;
        }
        else
        {
            var major = _listMajor.FirstOrDefault(c => c.Id == _selectedMajorId);
            _listTagForSelect = major == null ? new() : major.ListTag;
        }
    }

    private async Task OnClickTagAdd()
    {
        List<TagDTO> lstBeforeChange = new();
        foreach (var i in ListTagSelected) lstBeforeChange.Add(i);

        var parameters = new DialogParameters();

        parameters.Add(nameof(CustomTagSelect.ListTag), ListTagSelected);
        parameters.Add(nameof(CustomTagSelect.ListTagFromDB), _listTagForSelect);


        var dialog = DialogService.Show<CustomTagSelect>("Add Tags", parameters);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {

            ListTagSelected = (List<TagDTO>)result.Data;
        }
        else
        {
            ListTagSelected = lstBeforeChange;
        }
    }

    private void TagOnMouseOver(Guid idTag)
    {
        _hovingTagId = idTag;
    }

    private void TagOnClickRemove(Guid idTag)
    {
        ListTagSelected.Remove(ListTagSelected.FirstOrDefault(c => c.Id == idTag) ?? new());
    }

    private async Task OnClickSave()
    {
        PostCreateRequest.Title = _bindTitle;
        await BindListTagSelected.InvokeAsync(ListTagSelected);
        await OnSave.InvokeAsync();
    }

}
