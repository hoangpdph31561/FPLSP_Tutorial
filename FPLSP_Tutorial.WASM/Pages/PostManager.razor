@page "/post-manager"
@layout ManagementLayout

@using FPLSP_Tutorial.Application.DataTransferObjects.ClientPost;
@using FPLSP_Tutorial.Application.DataTransferObjects.Tag;
@using FPLSP_Tutorial.Application.ValueObjects.Response;
@using FPLSP_Tutorial.WASM.Data.DataTransferObjects.Post;
@using FPLSP_Tutorial.WASM.Data.DataTransferObjects.Post.Request;
@using FPLSP_Tutorial.WASM.Data.Pagination;
@using FPLSP_Tutorial.WASM.Repo.Interfaces;

@inject NavigationManager _navManager;
@inject IPostRepo _repoPost

<CustomListDisplay HideSearch="true" Label="Quản lý bài viết" IsLoading="@_isLoadingAll">
    <HeaderContent>
        <MudChip Icon="@Icons.Material.Filled.Add" OnClick="@(async () => { })" Color="Color.Primary">Thêm</MudChip>
    </HeaderContent>
    <BodyContent>
        <MudTable Items="@_listPost">
            <HeaderContent>
                <MudTh>STT</MudTh>
                <MudTh>Tiêu đề</MudTh>
                <MudTh>Tag</MudTh>
                <MudTh>Trạng thái</MudTh>
                <MudTh>Hành động</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@(_listPost.IndexOf(context) + 1)</MudTd>
                <MudTd Style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap; max-width: 10vw;">@context.Title</MudTd>
                <MudTd>
                    @foreach(var i in context.ListTag.Take(3))
                    {
                        <MudChip Variant="Variant.Outlined">@i.Name</MudChip>
                    }
                    @if(context.ListTag.Count() > 3)
                    {
                        string tooltip = "";
                        foreach(var tag in context.ListTag.Skip(3))
                        {
                            if (tooltip != "") tooltip += ", ";
                            tooltip += tag.Name;
                        }
                        <MudTooltip Text="tooltip">
                            <MudChip Variant="Variant.Outlined">
                                @("+" + (context.ListTag.Count() - 3))
                            </MudChip>
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd><BadgeEntityStatus Status="@context.Status"/></MudTd>
                <MudTd>
                    @if(idPost != null)
                    {
                        <MudChip OnClick="@(() => _navManager.NavigateTo($"/post-mananger?idPost={context.Id}"))">Xem bài viết con</MudChip>
                    }
                    
                    <MudChip Color="Color.Primary">Chỉnh sửa</MudChip>
                    <MudChip Color="Color.Error">Xóa</MudChip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </BodyContent>
</CustomListDisplay>


@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? idPost { get; set; }

    [Inject] 
    public HttpClient _http { get; set; }

    private bool _isLoadingAll = true;

    List<PostDto> _listPost = new();
    ViewPostWithPaginationRequest _prPost = new()
        {
            PageNumber = 1,
            PageSize = 10,
        };

    protected override async Task OnInitializedAsync()
    {
        _prPost.PostId = idPost == null ? null : Guid.Parse(idPost);
        await LoadData().ContinueWith((result) =>
        {
            _isLoadingAll = false ;
        });
    }

    private async Task LoadData()
    {
        _listPost = (await _repoPost.GetListWithPaginationAsync(_prPost)).Data.ToList();
    }
}
