@using FPLSP_Tutorial.WASM.Data.DTO.Major;
@using FPLSP_Tutorial.WASM.Data.DTO.Major.Request;
@using FPLSP_Tutorial.WASM.Enums;
@using FPLSP_Tutorial.WASM.Service.Interfaces;


<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="majorUpdate.Name" For="() => majorUpdate.Name" Label="Tên chuyên ngành"></MudTextField>
        <MudTextField @bind-Value="majorUpdate.Code" For="() => majorUpdate.Code" Label="Mã chuyên ngành"></MudTextField>
        <MudSelect @bind-Value="selectedStatus" Label="Trạng thái" For="() => selectedStatus" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem TValue="EntityStatus" Value="EntityStatus.Active">Hoạt động</MudSelectItem>
            <MudSelectItem TValue="EntityStatus" Value="EntityStatus.InActive">Không hoạt động</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="OnClickCancel">Hủy</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Info" @onclick="Reset">Làm mới</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success" @onclick="Updatemajor">Lưu</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [Parameter]
    public Guid idMajor { get; set; }
    [Parameter]
    public EventCallback onCloseDetail { get; set; }
    [Inject]
    public IMajorRepository majorRepository { get; set; }
    [Inject]
    public IDialogService dialogService { get; set; }
    [Inject]
    public ISnackbar snackbar { get; set; }

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    void OnClickCancel() => MudDialog.Cancel();

    private MajorUpdateRequest majorUpdate = new();
    private MajorDTO major;
    private EntityStatus selectedStatus = EntityStatus.Active;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    private async Task LoadData()
    {
        major = await majorRepository.GetMajorById(idMajor);
        majorUpdate.Id = major.Id;
        majorUpdate.Name = major.Name;
        majorUpdate.Status = major.Status;
    }

  
    private bool CheckChangeData()
    {
        return major.Name != majorUpdate.Name || major.Code != majorUpdate.Code || major.Status != majorUpdate.Status;
    }
    private async Task Updatemajor()
    {
        var confirm = await dialogService.ShowMessageBox
        (
            "Thông báo",
            "Xác nhận sửa chuyên ngành",
            "Xác nhận",
            cancelText: "Hủy"
        );
        if (confirm == true)
        {
            var result = await majorRepository.UpdateMajorAsync(majorUpdate);
            if (result)
            {
                if (CheckChangeData())
                {
                    OnClickCancel();
                    snackbar.Add("Sửa thành công", Severity.Success);
                }
                else
                {
                    OnClickCancel();
                    snackbar.Add("Không có thay đổi dữ liệu để cập nhật", Severity.Warning);
                }
            }
            else
            {
                snackbar.Add("Sửa thất bại", Severity.Error);
            }
        }
    }
    private async Task Reset()
    {
        await LoadData();
    }
}
